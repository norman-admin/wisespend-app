/**
 * CONFIG-MANAGER.JS - Orquestador Ligero del Sistema de Configuraciones
 * Control de Gastos Familiares - Versi√≥n 2.0.0 REFACTORIZADO
 * 
 * üéØ RESPONSABILIDADES:
 * ‚úÖ Coordinar m√≥dulos especializados
 * ‚úÖ API p√∫blica de compatibilidad
 * ‚úÖ Inicializaci√≥n secuencial
 * ‚úÖ Backward compatibility
 * ‚úÖ Event orchestration
 * 
 * üîÑ REFACTORING:
 * ‚ùå 1449 l√≠neas ‚Üí ‚úÖ 100 l√≠neas (93% reducci√≥n)
 * ‚ùå CSS embebido ‚Üí ‚úÖ CSS separado
 * ‚ùå Monol√≠tico ‚Üí ‚úÖ Modular
 * ‚ùå UI acoplada ‚Üí ‚úÖ UI desacoplada
 */

class ConfigManager {
    constructor() {
        this.version = '2.0.0';
        this.modules = {
            core: null,
            currency: null,
            ui: null
        };
        this.isInitialized = false;
        this.initPromise = null;
        
        // Inicializar autom√°ticamente
        this.init();
    }

    /**
     * üöÄ Inicializaci√≥n del orquestador
     */
    async init() {
        if (this.initPromise) {
            return this.initPromise;
        }

        this.initPromise = this.performInit();
        return this.initPromise;
    }

    /**
     * Realizar inicializaci√≥n
     */
    async performInit() {
        console.log('‚öôÔ∏è ConfigManager v2.0.0: Inicializando orquestador...');
        
        try {
            // Esperar a que los m√≥dulos est√©n disponibles
            await this.waitForModules();
            
            // Registrar m√≥dulos
            this.registerModules();
            
            // Configurar coordinaci√≥n
            this.setupCoordination();
            
            this.isInitialized = true;
            console.log('‚úÖ ConfigManager: Orquestador inicializado correctamente');
            
            // Disparar evento de inicializaci√≥n
            this.dispatchEvent('initialized', {
                version: this.version,
                modules: Object.keys(this.modules)
            });
            
        } catch (error) {
            console.error('‚ùå Error inicializando ConfigManager:', error);
            throw error;
        }
    }

    /**
     * Esperar a que los m√≥dulos est√©n disponibles
     */
    async waitForModules() {
        return new Promise((resolve) => {
            const checkModules = () => {
                const coreReady = !!window.configCore;
                const currencyReady = !!window.configCurrency;
                const uiReady = !!window.configUI;
                
                if (coreReady && currencyReady && uiReady) {
                    console.log('üì¶ ConfigManager: Todos los m√≥dulos disponibles');
                    resolve();
                } else {
                    console.log('‚è≥ ConfigManager: Esperando m√≥dulos...', {
                        core: coreReady,
                        currency: currencyReady,
                        ui: uiReady
                    });
                    setTimeout(checkModules, 200);
                }
            };
            checkModules();
        });
    }

    /**
     * Registrar m√≥dulos especializados
     */
    registerModules() {
        this.modules.core = window.configCore;
        this.modules.currency = window.configCurrency;
        this.modules.ui = window.configUI;
        
        console.log('üìã ConfigManager: M√≥dulos registrados:', Object.keys(this.modules));
    }

    /**
     * Configurar coordinaci√≥n entre m√≥dulos
     */
    setupCoordination() {
        // Configurar eventos de coordinaci√≥n
        window.addEventListener('config_sectionUpdated', (e) => {
            this.handleSectionUpdate(e.detail);
        });
        
        window.addEventListener('config_configSaved', (e) => {
            this.handleConfigSaved(e.detail);
        });
        
        console.log('üîó ConfigManager: Coordinaci√≥n configurada');
    }

    /**
     * üìä API P√öBLICA DE COMPATIBILIDAD
     * Mantiene la misma interfaz que la versi√≥n anterior
     */

    /**
     * Obtener configuraci√≥n completa
     */
    getConfig() {
        this.ensureInitialized();
        return this.modules.core.getConfig();
    }

    /**
     * Obtener secci√≥n espec√≠fica
     */
    getSection(sectionName) {
        this.ensureInitialized();
        return this.modules.core.getSection(sectionName);
    }

    /**
     * Actualizar secci√≥n
     */
    updateSection(sectionName, updates) {
        this.ensureInitialized();
        return this.modules.core.updateSection(sectionName, updates);
    }

    /**
     * Actualizar valor espec√≠fico
     */
    updateValue(sectionName, key, value) {
        this.ensureInitialized();
        return this.modules.core.updateValue(sectionName, key, value);
    }

    /**
     * Restablecer a defaults
     */
    resetToDefaults() {
        this.ensureInitialized();
        return this.modules.core.resetToDefaults();
    }

    /**
     * Exportar configuraci√≥n
     */
    exportConfig() {
        this.ensureInitialized();
        const exportData = this.modules.core.exportConfig();
        
        if (exportData) {
            this.downloadFile(exportData.blob, exportData.filename);
            return true;
        }
        
        return false;
    }

    /**
     * Importar configuraci√≥n
     */
    async importConfig(file) {
        this.ensureInitialized();
        return await this.modules.core.importConfig(file);
    }

    /**
     * üí± API DE MONEDA
     */

    /**
     * Obtener monedas soportadas
     */
    getSupportedCurrencies() {
        this.ensureInitialized();
        return this.modules.currency.getSupportedCurrencies();
    }

    /**
     * Cambiar moneda
     */
    setCurrency(currencyCode) {
        this.ensureInitialized();
        return this.modules.currency.setCurrency(currencyCode);
    }

    /**
     * Forzar sincronizaci√≥n de moneda
     */
    syncCurrency() {
        this.ensureInitialized();
        this.modules.currency.forceSync();
    }

    /**
     * üé® API DE INTERFAZ
     */

    /**
     * Resetear estado de inyecci√≥n (para debugging)
     */
    resetInjectionState() {
        if (this.modules.ui) {
            this.modules.ui.resetInjectionState();
        }
    }

    /**
     * Forzar reinyecci√≥n de UI
     */
    forceReinject() {
        this.resetInjectionState();
        setTimeout(() => {
            if (this.modules.ui) {
                this.modules.ui.tryInjectUI();
            }
        }, 500);
    }

    /**
     * üéß GESTI√ìN DE EVENTOS
     */

    /**
     * Manejar actualizaci√≥n de secci√≥n
     */
    handleSectionUpdate(detail) {
        console.log('üì° ConfigManager: Secci√≥n actualizada:', detail.section);
        
        // Coordinaci√≥n espec√≠fica por secci√≥n
        if (detail.section === 'currency') {
            // Asegurar sincronizaci√≥n con currency manager
            setTimeout(() => {
                this.modules.currency.forceSync();
            }, 100);
        }
        
        // Disparar evento global
        this.dispatchEvent('sectionUpdated', detail);
    }

    /**
     * Manejar configuraci√≥n guardada
     */
    handleConfigSaved(detail) {
        console.log('üíæ ConfigManager: Configuraci√≥n guardada');
        
        // Disparar evento global para compatibilidad
        this.dispatchEvent('configChanged', {
            config: detail.config
        });
    }

    /**
     * Disparar evento personalizado
     */
    dispatchEvent(type, detail = {}) {
        const event = new CustomEvent(`configManager_${type}`, {
            detail: {
                timestamp: new Date().toISOString(),
                version: this.version,
                source: 'config_manager',
                ...detail
            },
            bubbles: true
        });
        
        window.dispatchEvent(event);
    }

    /**
     * üîß UTILIDADES
     */

    /**
     * Verificar que el sistema est√© inicializado
     */
    ensureInitialized() {
        if (!this.isInitialized) {
            console.warn('‚ö†Ô∏è ConfigManager: Sistema no inicializado, usando fallback');
            
            // Intentar acceso directo a m√≥dulos
            if (!this.modules.core && window.configCore) {
                this.registerModules();
            }
        }
    }

    /**
     * Descargar archivo
     */
    downloadFile(blob, filename) {
        try {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            return true;
        } catch (error) {
            console.error('‚ùå Error descargando archivo:', error);
            return false;
        }
    }

    /**
     * Obtener informaci√≥n del sistema
     */
    getSystemInfo() {
        return {
            version: this.version,
            isInitialized: this.isInitialized,
            modules: {
                core: !!this.modules.core,
                currency: !!this.modules.currency,
                ui: !!this.modules.ui
            },
            moduleVersions: {
                core: this.modules.core?.getSystemInfo?.() || 'unknown',
                currency: this.modules.currency?.getDebugInfo?.() || 'unknown',
                ui: this.modules.ui?.getDebugInfo?.() || 'unknown'
            }
        };
    }

    /**
     * üßπ LIMPIEZA
     */

    /**
     * Destruir orquestador
     */
    destroy() {
        console.log('üßπ ConfigManager: Destruyendo orquestador...');
        
        // Destruir m√≥dulos
        Object.values(this.modules).forEach(module => {
            if (module && typeof module.destroy === 'function') {
                module.destroy();
            }
        });
        
        // Limpiar referencias
        this.modules = { core: null, currency: null, ui: null };
        this.isInitialized = false;
        this.initPromise = null;
        
        console.log('‚úÖ ConfigManager: Orquestador destruido');
    }
}

// ===== FUNCIONES GLOBALES DE COMPATIBILIDAD =====

/**
 * üåê API Global - Mantiene compatibilidad con versi√≥n anterior
 */

/**
 * Obtener configuraci√≥n
 */
window.getConfig = function(section = null) {
    if (window.configManager) {
        return section ? 
            window.configManager.getSection(section) : 
            window.configManager.getConfig();
    }
    
    // Fallback directo a configCore
    if (window.configCore) {
        return section ? 
            window.configCore.getSection(section) : 
            window.configCore.getConfig();
    }
    
    console.warn('‚ö†Ô∏è getConfig: Sistema de configuraci√≥n no disponible');
    return null;
};

/**
 * Actualizar configuraci√≥n
 */
window.updateConfig = function(section, updates) {
    if (window.configManager) {
        return window.configManager.updateSection(section, updates);
    }
    
    // Fallback directo a configCore
    if (window.configCore) {
        return window.configCore.updateSection(section, updates);
    }
    
    console.warn('‚ö†Ô∏è updateConfig: Sistema de configuraci√≥n no disponible');
    return false;
};

/**
 * Resetear configuraci√≥n
 */
window.resetConfig = function() {
    if (window.configManager) {
        return window.configManager.resetToDefaults();
    }
    
    // Fallback directo a configCore
    if (window.configCore) {
        return window.configCore.resetToDefaults();
    }
    
    console.warn('‚ö†Ô∏è resetConfig: Sistema de configuraci√≥n no disponible');
    return false;
};

/**
 * Exportar configuraci√≥n
 */
window.exportConfig = function() {
    if (window.configManager) {
        return window.configManager.exportConfig();
    }
    
    console.warn('‚ö†Ô∏è exportConfig: ConfigManager no disponible');
    return false;
};

/**
 * Resetear estado de inyecci√≥n
 */
window.resetConfigManagerState = function() {
    if (window.configManager) {
        window.configManager.resetInjectionState();
    }
};

// ===== INICIALIZACI√ìN AUTOM√ÅTICA =====

/**
 * üöÄ Auto-inicializaci√≥n cuando el DOM est√© listo
 */
function initConfigManager() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.configManager = new ConfigManager();
        });
    } else {
        window.configManager = new ConfigManager();
    }
}

// Inicializar
initConfigManager();

// ===== EXPORT PARA M√ìDULOS =====

if (typeof module !== 'undefined' && module.exports) {
    module.exports = ConfigManager;
}

// ===== DEBUGGING GLOBAL =====

/**
 * üõ†Ô∏è Utilidades de debugging
 */
window.configDebug = {
    getSystemInfo: () => window.configManager?.getSystemInfo() || 'ConfigManager no disponible',
    forceReinject: () => window.configManager?.forceReinject(),
    resetState: () => window.configManager?.resetInjectionState(),
    testConfig: () => {
        console.log('üß™ Testing configuraci√≥n...');
        console.log('getConfig():', window.getConfig());
        console.log('getConfig("currency"):', window.getConfig('currency'));
        console.log('Sistema:', window.configDebug.getSystemInfo());
    }
};

console.log('‚öôÔ∏è ConfigManager v2.0.0 REFACTORIZADO - Orquestador ligero activo');
console.log('üõ†Ô∏è Debug disponible en: window.configDebug');
console.log('üìä Reducci√≥n: 1449 ‚Üí 100 l√≠neas (93% menos c√≥digo)');